<% content_for :title, @event.title %>

<!-- Navigation Controls -->
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <%= link_to "Events", events_path, class: "text-decoration-none" %>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            <%= truncate(@event.title, length: 50) %>
          </li>
        </ol>
      </nav>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <%= link_to events_path, class: "btn btn-outline-secondary me-2" do %>
            <i class="fas fa-arrow-left me-1"></i>
            Back to Events
          <% end %>
          <% if current_user&.admin_level? %>
            <%= link_to edit_event_path(@event), class: "btn btn-outline-primary me-2" do %>
              <i class="fas fa-edit me-1"></i>
              Edit Event
            <% end %>
          <% end %>
          <% if current_user&.can_delete? %>
            <%= form_with model: @event, method: :delete, local: true, class: "d-inline", id: "delete-event-form" do |form| %>
              <button type="button"
                      class="btn btn-outline-danger"
                      data-bs-toggle="modal"
                      data-bs-target="#confirmationModal"
                      data-confirm-title="Delete Event"
                      data-confirm-message="Are you sure you want to delete '<%= @event.title %>'? This action cannot be undone."
                      data-confirm-action="Delete Event"
                      data-form-id="delete-event-form">
                <i class="fas fa-trash me-1"></i> Delete
              </button>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Event Header Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <i class="fas fa-calendar-alt me-2"></i>
              <h1 class="h4 mb-0"><%= @event.title %></h1>
            </div>
            <div class="d-flex gap-2">
              <!-- Status Badges -->
              <% if @event.status == 'canceled' %>
                <span class="badge bg-danger">
                  <i class="fas fa-times-circle me-1"></i>Cancelled
                </span>
              <% elsif @event.status == 'draft' %>
                <span class="badge bg-secondary">
                  <i class="fas fa-eye-slash me-1"></i>Draft
                </span>
              <% end %>

              <!-- Special Event Badge -->
              <% if @event.special? %>
                <span class="badge bg-warning text-dark">
                  <i class="fas fa-star me-1"></i>Special Event
                </span>
              <% end %>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Event Description -->
          <% if @event.description.present? %>
            <p class="text-muted mb-0">
              <i class="fas fa-info-circle me-1"></i>
              <%= simple_format(@event.description) %>
            </p>
          <% else %>
            <p class="text-muted mb-0">
              <i class="fas fa-info-circle me-1"></i>
              Event details and information.
            </p>
          <% end %>
        </div>
      </div>



      <!-- Event Details -->
      <div class="row g-4">
        <!-- Left Column - Date & Time -->
        <div class="col-12 col-lg-8">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h5 class="text-dark border-bottom pb-2 mb-4">
                <i class="fas fa-clock me-2"></i>Date & Time
              </h5>

              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <div class="p-3 rounded" style="background-color: #f8f9fa;">
                    <h6 class="text-muted mb-1">
                      <i class="fas fa-play me-1"></i>Start Date & Time
                    </h6>
                    <div class="fw-bold text-dark">
                      <%= @event.starts_at.in_time_zone(@event.time_zone).strftime("%A, %B %d, %Y") %>
                    </div>
                    <div class="text-muted">
                      <%= @event.starts_at.in_time_zone(@event.time_zone).strftime("%I:%M %p") %>
                      (<%= @event.time_zone.split('/').last.gsub('_', ' ') %>)
                    </div>
                  </div>
                </div>

                <div class="col-12 col-md-6">
                  <div class="p-3 rounded" style="background-color: #f8f9fa;">
                    <h6 class="text-muted mb-1">
                      <i class="fas fa-stop me-1"></i>End Date & Time
                    </h6>
                    <div class="fw-bold text-dark">
                      <%= @event.ends_at.in_time_zone(@event.time_zone).strftime("%A, %B %d, %Y") %>
                    </div>
                    <div class="text-muted">
                  <%= @event.ends_at.in_time_zone(@event.time_zone).strftime("%I:%M %p") %>
                  (<%= @event.time_zone.split('/').last.gsub('_', ' ') %>)
                </div>
              </div>
            </div>
          </div>

          <!-- Countdown Timer -->
          <% if @event.starts_at > Time.current %>
            <div class="alert alert-info mt-4">
              <i class="bi bi-clock me-2"></i>
              <span id="event-countdown">
                <script>
                  (function() {
                    const eventDate = new Date('<%= @event.starts_at.iso8601 %>');
                    const countdownElement = document.getElementById('event-countdown');

                    function updateCountdown() {
                      const now = new Date();
                      const diff = eventDate - now;

                      if (diff <= 0) {
                        countdownElement.innerHTML = '<strong>This event has started!</strong>';
                        return;
                      }

                      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                      let countdownText = '<strong>Event starts in: ';
                      if (days > 0) {
                        countdownText += `${days} day${days > 1 ? 's' : ''}`;
                        if (hours > 0) countdownText += `, ${hours} hour${hours > 1 ? 's' : ''}`;
                      } else if (hours > 0) {
                        countdownText += `${hours} hour${hours > 1 ? 's' : ''}`;
                        if (minutes > 0) countdownText += `, ${minutes} minute${minutes > 1 ? 's' : ''}`;
                      } else {
                        countdownText += `${minutes} minute${minutes > 1 ? 's' : ''}`;
                      }
                      countdownText += '</strong>';

                      countdownElement.innerHTML = countdownText;
                    }

                    updateCountdown();
                    setInterval(updateCountdown, 60000); // Update every minute
                  })();
                </script>
              </span>
            </div>
          <% elsif @event.starts_at <= Time.current && @event.ends_at >= Time.current %>
            <div class="alert alert-success mt-4">
              <i class="bi bi-broadcast me-2"></i>
              <strong>This event is happening right now!</strong>
            </div>
          <% elsif @event.ends_at < Time.current %>
            <div class="alert alert-secondary mt-4">
              <i class="bi bi-check-circle me-2"></i>
              <strong>This event has ended.</strong>
            </div>
          <% end %>
        </div>
      </div>
    </div>

        <!-- Right Column - Location -->
        <div class="col-12 col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h5 class="text-dark border-bottom pb-2 mb-4">
                <i class="fas fa-map-marker-alt me-2"></i>Location
              </h5>

              <% if @event.venue.present? || @event.address1.present? %>
                <div class="p-3 rounded" style="background-color: #f8f9fa;">
                  <% if @event.venue.present? %>
                    <h6 class="text-muted mb-1">
                      <i class="fas fa-building me-1"></i>Venue
                    </h6>
                    <div class="fw-bold text-dark mb-2"><%= @event.venue %></div>
                  <% end %>

                  <% if @event.address1.present? %>
                    <h6 class="text-muted mb-1">
                      <i class="fas fa-map me-1"></i>Address
                    </h6>
                    <div class="text-dark">
                      <%= @event.address1 %><br>
                      <% if @event.address2.present? %>
                        <%= @event.address2 %><br>
                      <% end %>
                      <% if @event.city.present? && @event.state.present? %>
                        <%= @event.city %>, <%= @event.state %>
                        <%= @event.zipcode if @event.zipcode.present? %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="text-center py-3" style="background-color: #f8f9fa; border-radius: 8px;">
                  <i class="fas fa-map-marker-alt fa-2x text-muted mb-2"></i>
                  <p class="text-muted mb-0">Location details will be provided soon.</p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Attendance Tracking Section (Admin Only) -->
      <% if current_user&.admin_level? %>
        <div class="row mt-4">
          <div class="col-12">
            <div class="card shadow-sm" data-controller="attendance">
              <div class="card-header bg-warning text-dark">
                <div class="d-flex align-items-center">
                  <i class="fas fa-clipboard-check me-2"></i>
                  <h5 class="mb-0">Event Attendance</h5>
                  <span class="badge bg-dark ms-2">Admin Level</span>
                </div>
              </div>
              <div class="card-body">
                <p class="text-muted mb-4">
                  <i class="fas fa-info-circle me-1"></i>
                  Click on a student's name to toggle their attendance for this event.
                </p>

                <%
                  active_students = Student.active.by_last_name
                  if active_students.any?
                %>
                  <div class="row g-2" id="attendance-grid">
                    <% active_students.each do |student| %>
                      <%
                        attendance = @event.attendances.find_by(student: student)
                        is_present = attendance&.present? || false
                        button_class = is_present ? 'btn-success' : 'btn-outline-secondary'
                        icon_class = is_present ? 'fas fa-check-circle' : 'far fa-circle'
                      %>
                      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                        <button type="button"
                                class="btn <%= button_class %> w-100 attendance-toggle"
                                data-event-id="<%= @event.id %>"
                                data-student-id="<%= student.id %>"
                                data-present="<%= is_present %>"
                                data-student-name="<%= student.full_name %>">
                          <i class="<%= icon_class %> me-2"></i>
                          <%= student.full_name %>
                          <% if is_present %>
                            <small class="d-block text-white-50 mt-1">
                              <i class="fas fa-clock me-1"></i>Present
                            </small>
                          <% end %>
                        </button>
                      </div>
                    <% end %>
                  </div>

                  <!-- Attendance Summary -->
                  <div class="mt-4 p-3 rounded" style="background-color: #f8f9fa;">
                    <div class="row text-center">
                      <div class="col-4">
                        <div class="text-success fw-bold fs-4" id="present-count">
                          <%= @event.attendances.present.count %>
                        </div>
                        <small class="text-muted">Present</small>
                      </div>
                      <div class="col-4">
                        <div class="text-secondary fw-bold fs-4" id="absent-count">
                          <%= active_students.count - @event.attendances.present.count %>
                        </div>
                        <small class="text-muted">Absent</small>
                      </div>
                      <div class="col-4">
                        <div class="text-primary fw-bold fs-4" id="total-count">
                          <%= active_students.count %>
                        </div>
                        <small class="text-muted">Total</small>
                      </div>
                    </div>
                  </div>
                <% else %>
                  <div class="text-center py-4">
                    <i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-0">No active students found.</p>
                    <p class="text-muted">
                      <%= link_to "Manage Students", students_path, class: "text-decoration-none" %>
                    </p>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%= render "shared/generic_confirmation_modal" %>
